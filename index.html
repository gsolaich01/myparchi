<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MyParchi">
    <meta name="description" content="MyParchi Pro - Digital Parchi Book for Indian Businesses">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <title>MyParchi Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            dark: '#1e3a8a',
                            primary: '#2563eb',
                            light: '#dbeafe',
                            bg: '#f1f5f9',
                            text: '#1e293b',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .hide { display: none !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .screen { animation: fadeSlideUp 0.25s ease-out; }
        @keyframes fadeSlideUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .nav-item.active { color: #1e3a8a; }
        .input-field:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); }
        
        /* PWA Install Banner */
        .install-banner {
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
        
        /* Security overlay animation */
        .security-overlay {
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%);
        }
        
        /* Splash screen */
        .splash-screen {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        }
        
        /* Safe area for notched phones */
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden text-brand-text bg-brand-bg">

    <!-- Splash Screen -->
    <div id="splashScreen" class="splash-screen fixed inset-0 z-[9999] flex flex-col items-center justify-center text-white">
        <div class="bg-white/10 w-24 h-24 rounded-3xl flex items-center justify-center border border-white/20 mb-6 animate-pulse">
            <i class="fa-solid fa-print text-5xl text-white"></i>
        </div>
        <h1 class="text-3xl font-black tracking-tight">MY PARCHI</h1>
        <p class="text-blue-200 text-sm mt-2">Digital Parchi Book</p>
        <div class="mt-8">
            <div class="w-8 h-8 border-4 border-white/30 border-t-white rounded-full animate-spin"></div>
        </div>
    </div>

    <!-- PWA Install Banner -->
    <div id="installBanner" class="install-banner hide fixed top-0 left-0 right-0 z-[100] p-4 pt-safe text-white flex justify-between items-center">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-download text-xl"></i>
            <div>
                <div class="font-bold text-sm">Install MyParchi</div>
                <div class="text-xs text-blue-200">Add to Home Screen for offline use</div>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="dismissInstallBanner()" class="text-white/70 px-3 py-1 text-sm">Later</button>
            <button onclick="installPWA()" class="bg-white text-brand-dark px-4 py-1.5 rounded-lg text-sm font-bold">Install</button>
        </div>
    </div>

    <!-- Main Header -->
    <div class="bg-brand-dark text-white p-4 pt-safe z-30 flex justify-between items-center shadow-lg" id="mainHeader">
        <div class="flex items-center gap-3">
            <div class="bg-white/10 w-10 h-10 rounded-xl flex items-center justify-center border border-white/20">
                <i class="fa-solid fa-print text-lg text-white"></i> 
            </div>
            <div>
                <h1 class="text-lg font-bold tracking-tight uppercase" id="headerTitle">MY PARCHI</h1>
                <div class="text-[10px] text-blue-200 font-medium tracking-wider uppercase flex items-center gap-1">
                    <i class="fa-solid fa-check-circle"></i> <span id="headerSubtitle">myparchi</span>
                </div>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="triggerRestore()" class="bg-white/10 hover:bg-white/20 text-white w-9 h-9 rounded-lg border border-white/20 flex items-center justify-center" title="Restore Data">
                <i class="fa-solid fa-upload text-sm"></i>
            </button>
            <input type="file" id="restoreFile" class="hidden" accept=".json" onchange="processRestore(this)">
            
            <button onclick="downloadBackup()" class="bg-brand-primary hover:bg-blue-600 text-white text-xs px-3 py-1.5 rounded-lg border border-white/20 font-bold flex items-center gap-1 shadow-md">
                <i class="fa-solid fa-download"></i> Backup
            </button>
            
            <button onclick="showHelp()" class="bg-rose-600 hover:bg-rose-500 text-white w-9 h-9 rounded-lg border border-white/20 flex items-center justify-center shadow-md" title="Help">
                <i class="fa-solid fa-question text-sm"></i>
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="flex-1 overflow-y-auto p-4 pb-28 relative no-scrollbar" id="mainContainer" onclick="closeAllSuggestions()">
        
        <!-- Entry Screen -->
        <div id="screen-entry" class="screen">
            
            <div class="bg-white p-1.5 rounded-xl shadow-sm mb-6 flex border border-brand-light">
                <button onclick="setMode('sale')" id="btn-sale" class="flex-1 py-3 px-1 rounded-lg text-xs font-bold transition-all uppercase">Sale</button>
                <button onclick="setMode('purchase')" id="btn-purchase" class="flex-1 py-3 px-1 rounded-lg text-xs font-bold transition-all uppercase">Purchase</button>
                <button onclick="setMode('receipt')" id="btn-receipt" class="flex-1 py-3 px-1 rounded-lg text-xs font-bold transition-all uppercase">Receipt</button>
                <button onclick="setMode('payment')" id="btn-payment" class="flex-1 py-3 px-1 rounded-lg text-xs font-bold transition-all uppercase">Payment</button>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-brand-light/50 mb-6 space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wide ml-1">Date</label>
                    <div class="relative mt-1">
                        <input type="date" id="txnDate" class="w-full bg-brand-bg border border-slate-200 text-brand-text text-sm rounded-xl p-3 pl-10 outline-none font-bold uppercase">
                        <i class="fa-regular fa-calendar absolute left-3.5 top-3.5 text-brand-primary"></i>
                    </div>
                </div>
                <div class="relative">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wide ml-1">Party Name</label>
                    <div class="relative mt-1">
                        <input type="text" id="partyName" placeholder="E.G. SHARMA TRADERS" 
                            class="input-field w-full bg-brand-bg border border-slate-200 text-brand-text text-lg rounded-xl p-3 pl-10 outline-none font-black placeholder-slate-300 uppercase" 
                            oninput="this.value = this.value.toUpperCase(); showPartySuggestions(this.value)" 
                            onclick="event.stopPropagation()">
                        <i class="fa-solid fa-user-tag absolute left-3.5 top-4 text-brand-primary"></i>
                    </div>
                    <div id="partySuggestions" class="bg-white border border-slate-200 shadow-2xl rounded-xl hide absolute w-full z-50 max-h-48 overflow-y-auto top-full mt-2 p-1"></div>
                </div>
            </div>

            <div id="item-section">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-brand-light/50 mb-4">
                    <div class="flex justify-between items-center mb-3 border-b border-slate-100 pb-2">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wide">Add Items</h3>
                        <span class="bg-brand-light text-brand-dark text-[10px] font-bold px-2 py-0.5 rounded">CART</span>
                    </div>
                    
                    <div class="flex gap-2 mb-3 relative">
                        <div class="flex-[2] relative">
                            <input type="text" id="itemName" placeholder="ITEM" class="input-field w-full bg-brand-bg border border-slate-200 rounded-lg p-2.5 text-sm outline-none font-bold uppercase" 
                                oninput="this.value = this.value.toUpperCase(); showItemSuggestions(this.value)"
                                onclick="event.stopPropagation()">
                            <div id="itemSuggestions" class="bg-white border border-slate-200 shadow-xl rounded-xl hide absolute w-full z-50 max-h-40 overflow-y-auto top-full mt-1 p-1"></div>
                        </div>
                        <input type="number" id="itemQty" placeholder="QTY" class="input-field w-16 bg-brand-bg border border-slate-200 rounded-lg p-2.5 text-sm outline-none font-bold text-center">
                    </div>
                    
                    <div class="flex gap-2">
                        <input type="number" id="itemRate" placeholder="RATE" class="input-field flex-[2] bg-brand-bg border border-slate-200 rounded-lg p-2.5 text-sm outline-none font-bold">
                        <button onclick="addToCart()" class="bg-brand-dark text-white px-5 rounded-lg text-sm font-bold shadow-lg shadow-brand-dark/20 active:scale-95 transition-transform"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
                <div id="cartList" class="space-y-2 mb-4"></div>
                <div class="flex justify-between items-end px-2 mt-4">
                    <span class="text-sm font-medium text-slate-500 mb-1">Total Bill Amount</span>
                    <span id="grandTotal" class="text-3xl font-black text-brand-dark tracking-tight">â‚¹0</span>
                </div>
            </div>

            <div id="cash-section" class="hide">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-brand-light/50 mb-4 space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wide ml-1">Amount</label>
                        <div class="relative mt-1">
                            <span class="absolute left-4 top-4 text-brand-primary text-lg font-bold">â‚¹</span>
                            <input type="number" id="cashAmount" placeholder="0" class="input-field w-full bg-brand-bg border border-slate-200 rounded-xl p-3 pl-10 text-2xl outline-none font-black text-brand-dark">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wide ml-1">Remarks</label>
                        <input type="text" id="cashRemarks" placeholder="NOTE..." class="input-field w-full bg-brand-bg border border-slate-200 rounded-xl p-3 mt-1 outline-none text-sm font-medium uppercase" oninput="this.value = this.value.toUpperCase()">
                    </div>
                </div>
            </div>

            <button id="saveBtn" onclick="saveTransaction()" class="w-full bg-brand-primary hover:bg-blue-600 text-white py-4 rounded-2xl font-bold text-lg shadow-xl shadow-brand-primary/30 mt-6 active:scale-95 transition-all flex justify-center items-center gap-2">
                <i class="fa-regular fa-circle-check"></i> SAVE
            </button>
        </div>

        <!-- Ledger Screen -->
        <div id="screen-ledger" class="screen hide">
            <div class="flex justify-between items-center mb-4 pl-1">
                <h2 class="text-xl font-black text-brand-dark">LEDGERS</h2>
                <button onclick="renderLedgerList()" class="text-xs bg-white border border-slate-300 px-2 py-1 rounded font-bold">Refresh</button>
            </div>

            <div class="flex gap-2 mb-4">
                <input type="date" id="ledStart" class="w-1/2 p-2 text-xs border rounded-lg font-bold bg-white" onchange="renderLedgerList()">
                <input type="date" id="ledEnd" class="w-1/2 p-2 text-xs border rounded-lg font-bold bg-white" onchange="renderLedgerList()">
            </div>

            <div class="relative mb-5">
                <i class="fa-solid fa-search absolute left-4 top-4 text-slate-400"></i>
                <input type="text" id="ledgerSearch" placeholder="SEARCH..." class="input-field w-full bg-white p-3.5 pl-11 border border-brand-light rounded-xl shadow-sm outline-none font-bold text-slate-700 uppercase" oninput="this.value = this.value.toUpperCase(); renderLedgerList(this.value)">
            </div>
            <div id="ledgerList" class="space-y-3 pb-20"></div>
        </div>

        <!-- Cashbook Screen -->
        <div id="screen-cashbook" class="screen hide">
            <div class="bg-gradient-to-br from-brand-dark to-brand-primary rounded-3xl p-6 text-white shadow-xl shadow-brand-primary/20 mb-6 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fa-solid fa-wallet text-6xl"></i></div>
                <p class="text-blue-200 text-xs font-bold uppercase tracking-widest mb-2">NET CASH IN HAND</p>
                <h2 class="text-4xl font-black tracking-tight" id="cashBalance">â‚¹0</h2>
            </div>

            <div class="flex gap-2 mb-4 px-1">
                <input type="date" id="cashStart" class="w-1/2 p-2 text-xs border rounded-lg font-bold bg-white" onchange="renderCashbook()">
                <input type="date" id="cashEnd" class="w-1/2 p-2 text-xs border rounded-lg font-bold bg-white" onchange="renderCashbook()">
            </div>

            <h3 class="font-bold text-slate-500 mb-3 text-xs uppercase tracking-widest ml-1">Transactions</h3>
            <div id="cashList" class="space-y-3 pb-20"></div>
        </div>

        <!-- Party History Screen -->
        <div id="screen-party-history" class="screen hide">
            <div class="flex justify-between items-center mb-4">
                <button onclick="switchTab('ledger')" class="text-brand-primary font-bold text-sm flex items-center gap-2 bg-white border border-brand-light px-4 py-2 rounded-lg shadow-sm"><i class="fa-solid fa-arrow-left"></i> BACK</button>
                <button onclick="printCurrentLedger()" class="bg-brand-primary text-white font-bold text-xs flex items-center gap-2 px-4 py-2 rounded-lg shadow-sm hover:bg-blue-600 transition-colors"><i class="fa-solid fa-print"></i> PRINT LEDGER</button>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-brand-light/50 mb-6 text-center">
                <div class="w-16 h-16 bg-brand-light rounded-full mx-auto flex items-center justify-center mb-3 text-2xl font-bold text-brand-dark" id="ph-avatar">#</div>
                <h2 class="text-xl font-black text-brand-dark uppercase" id="ph-name">PARTY NAME</h2>
                <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">CURRENT BALANCE</div>
                <div id="ph-balance" class="text-3xl font-black mt-2">â‚¹0</div>
            </div>
            <div id="ph-list" class="space-y-3 pb-20"></div>
        </div>

    </div>

    <!-- Bottom Navigation -->
    <div id="bottom-nav" class="fixed bottom-0 w-full bg-white border-t border-slate-200 flex justify-around py-3 z-50 pb-safe shadow-[0_-10px_40px_rgba(0,0,0,0.05)] rounded-t-2xl">
        <button onclick="switchTab('entry')" id="tab-entry" class="nav-item active flex flex-col items-center w-1/3 text-slate-400 transition-all"><i class="fa-solid fa-circle-plus text-2xl mb-1"></i><span class="text-[10px] font-bold uppercase mt-1">Entry</span></button>
        <button onclick="switchTab('ledger')" id="tab-ledger" class="nav-item flex flex-col items-center w-1/3 text-slate-400 transition-all"><i class="fa-solid fa-address-book text-2xl mb-1"></i><span class="text-[10px] font-bold uppercase mt-1">Ledgers</span></button>
        <button onclick="switchTab('cashbook')" id="tab-cashbook" class="nav-item flex flex-col items-center w-1/3 text-slate-400 transition-all"><i class="fa-solid fa-wallet text-2xl mb-1"></i><span class="text-[10px] font-bold uppercase mt-1">Cashbook</span></button>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="hide fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/90 backdrop-blur-sm" onclick="this.classList.add('hide')">
        <div class="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-sm" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-black text-brand-dark flex items-center gap-2"><i class="fa-solid fa-circle-info text-blue-500"></i> IMPORTANT</h2>
                <button onclick="document.getElementById('helpModal').classList.add('hide')" class="text-slate-400 hover:text-rose-500"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="space-y-4 text-sm text-slate-600">
                <div class="bg-emerald-50 p-3 rounded-xl border border-emerald-100 text-emerald-700 font-medium">
                    <i class="fa-solid fa-mobile-screen mr-1"></i> <b>PWA App:</b> Install this app on your home screen for best experience!
                </div>
                <div class="bg-rose-50 p-3 rounded-xl border border-rose-100 text-rose-700 font-medium">
                    <i class="fa-solid fa-triangle-exclamation mr-1"></i> <b>WARNING:</b> Data stored locally. Regular backups recommended.
                </div>
                <p>âœ… <b>BACKUP:</b> Click 'Backup' to save file to Downloads.</p>
                <p>ðŸ“‚ <b>RESTORE:</b> Click <i class="fa-solid fa-upload"></i> to load a backup file.</p>
                <p>ðŸ“± <b>OFFLINE:</b> App works without internet after installation.</p>
            </div>
            <button onclick="document.getElementById('helpModal').classList.add('hide')" class="mt-6 w-full bg-brand-dark text-white py-3 rounded-xl font-bold">GOT IT</button>
        </div>
    </div>

    <!-- Security/License Overlay (injected by JS when needed) -->
    <div id="securityOverlay" class="hide"></div>

    <!-- Main Application Script -->
    <script src="app.js"></script>
    
    <!-- Service Worker Registration -->
    <script>
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('SW registered:', reg.scope))
                    .catch(err => console.log('SW registration failed:', err));
            });
        }

        // PWA Install handling
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Show install banner after 3 seconds
            setTimeout(() => {
                if (!window.matchMedia('(display-mode: standalone)').matches) {
                    document.getElementById('installBanner').classList.remove('hide');
                }
            }, 3000);
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(choice => {
                    if (choice.outcome === 'accepted') {
                        console.log('User accepted install');
                    }
                    deferredPrompt = null;
                    document.getElementById('installBanner').classList.add('hide');
                });
            }
        }

        function dismissInstallBanner() {
            document.getElementById('installBanner').classList.add('hide');
            // Don't show again for 24 hours
            localStorage.setItem('installBannerDismissed', Date.now());
        }

        // Hide splash screen after load
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('splashScreen').style.opacity = '0';
                document.getElementById('splashScreen').style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    document.getElementById('splashScreen').classList.add('hide');
                }, 300);
            }, 1500);
        });
    </script>
</body>
</html>
